<div class="places-view">
  <top-bar-plan
    [steps]="[
      { label: 'Podstawowe', to: '/plan/basic-info', exact: false},
      { label: 'Miejsca',     to: '/plan/places', exact: false },
      { label: 'Trasy',       to: '/plan/routes', exact: false },
      { label: 'Rezerwacje',  to: '/plan/bookings', exact: false },
      { label: 'Checklist',   to: '/plan/checklist', exact: false },
      { label: 'PodglƒÖd',     to: '/plan/overview', exact: false }
    ]"
    [planId]="planId">
  </top-bar-plan>

  <div class="places-view__container">
    <div class="places-view__content-section">
      <div class="places-view__selected-section places-view__selected-section--main">
        <div class="places-view__header">
          <div>
            <p class="places-view__plan-name" *ngIf="planName">
              {{ planName }}
              <span class="places-view__plan-destination" *ngIf="planDestination">¬∑ {{ planDestination }}</span>
            </p>
            <h2 class="places-view__title">Miejsca w planie (edycja)</h2>
            <p class="places-view__subtitle">{{ selectedPlaces.length }} miejsc w planie</p>
          </div>
          <div class="places-view__actions-inline">
            <app-button
              variant="filter"
              label="Dodaj miejsce"
              (clicked)="onAddPlaceClick()">
            </app-button>
          </div>
        </div>

        <div class="places-view__place-type-filters">
          <app-button
            *ngFor="let placeType of placeTypes"
            [variant]="activePlaceType === placeType.id ? 'filter-active' : 'filter'"
            [label]="placeType.name"
            (clicked)="onFilterByPlaceType(placeType.id)">
          </app-button>
        </div>

        <div class="places-view__search">
          <app-search-bar
            placeholder="Szukaj w dodanych miejscach..."
            [value]="searchQuery"
            (valueChange)="onSearchChange($event)">
          </app-search-bar>
        </div>

        <div class="places-view__selected-places">
          <ng-container *ngIf="filteredSelectedPlaces.length > 0; else noPlacesSelected">
            <div class="places-list places-list--hierarchical">
              <ng-container *ngIf="activePlaceType === 'all'">
                <ng-container *ngFor="let place of filteredSelectedPlaces; let i = index">
                  <ng-template #placeCard let-place let-index="index" let-isChild="isChild" let-parentChildren="parentChildren">
                    <div class="place-card place-card--selected" [class.place-card--child]="isChild">
                      <div class="place-card__content">
                        <div class="place-card__compact-info">
                          <div class="place-card__name-row">
                            <div class="place-card__name">{{ place.name }}</div>
                            <div class="place-card__order-number">{{ place.order || (index + 1) }}</div>
                          </div>
                          <div class="place-card__address" *ngIf="place.address">
                            <app-form-icon name="location" [size]="12" color="rgba(82, 103, 156, 0.7)"></app-form-icon>
                            {{ place.address }}
                          </div>
                          <div class="place-card__meta-info" *ngIf="place.rating || place.priority || (place.tags && place.tags.length > 0)">
                            <span class="meta-item" *ngIf="place.priority">
                              {{ getPriorityLabel(place.priority) }}
                            </span>
                          </div>
                        </div>

                        <div class="place-card__expand-controls">
                          <button 
                            type="button"
                            class="expand-btn"
                            (click)="toggleExpand(place.id)">
                            <span>{{ place.isExpanded ? 'Ukryj szczeg√≥≈Çy' : 'Poka≈º szczeg√≥≈Çy' }}</span>
                            <span class="expand-icon">{{ place.isExpanded ? '‚ñ≤' : '‚ñº' }}</span>
                          </button>
                        </div>

                        <div class="place-card__details" *ngIf="place.isExpanded">
                          <div class="detail-section">
                            <label class="detail-label">Priorytet</label>
                            <div class="detail-value">{{ getPriorityLabel(place.priority) }}</div>
                          </div>

                          <div class="detail-section" *ngIf="place.notes">
                            <label class="detail-label">Notatki</label>
                            <div class="notes-readonly">{{ place.notes }}</div>
                          </div>
                        </div>
                      </div>

                      <div class="place-card__actions">
                        <button 
                          type="button"
                          class="order-btn"
                          (click)="onMoveUp(place.id)"
                          title="Przenie≈õ wy≈ºej">
                          ‚Üë
                        </button>
                        <button 
                          type="button"
                          class="order-btn"
                          (click)="onMoveDown(place.id)"
                          title="Przenie≈õ ni≈ºej">
                          ‚Üì
                        </button>
                      </div>
                    </div>
                  </ng-template>

                  <ng-container *ngTemplateOutlet="placeCard; context: { $implicit: place, index: i, isChild: false }"></ng-container>
                </ng-container>
              </ng-container>

              <ng-container *ngIf="activePlaceType !== 'all'">
                <div 
                  class="place-card place-card--selected" 
                  *ngFor="let place of filteredSelectedPlaces; let i = index">
                  <div class="place-card__content">
                    <div class="place-card__compact-info">
                      <div class="place-card__name-row">
                        <div class="place-card__name">{{ place.name }}</div>
                        <div class="place-card__order-number">{{ place.order || (i + 1) }}</div>
                      </div>
                      <div class="place-card__address" *ngIf="place.address">
                        <app-form-icon name="location" [size]="12" color="rgba(82, 103, 156, 0.7)"></app-form-icon>
                        {{ place.address }}
                      </div>
                    </div>
                  </div>
                  <div class="place-card__actions">
                    <button 
                      type="button"
                      class="order-btn"
                      (click)="onMoveUp(place.id)"
                      title="Przenie≈õ wy≈ºej">
                      ‚Üë
                    </button>
                    <button 
                      type="button"
                      class="order-btn"
                      (click)="onMoveDown(place.id)"
                      title="Przenie≈õ ni≈ºej">
                      ‚Üì
                    </button>
                  </div>
                </div>
              </ng-container>
            </div>
          </ng-container>

          <ng-template #noPlacesSelected>
            <div class="empty-state">
              <div class="empty-state__icon">üìç</div>
              <h4 class="empty-state__title">Brak wybranych miejsc</h4>
              <p class="empty-state__message">
                Dodaj miejsca, aby utworzyƒá plan.
              </p>
            </div>
          </ng-template>
        </div>

        <div class="places-view__actions">
          <app-button
            variant="basic-accept"
            label="Zapisz"
            (clicked)="onSave()">
          </app-button>
        </div>
      </div>
    </div>

    <div class="places-view__map">
      <app-google-map
        [places]="placesForMap"
        [center]="{ lat: 52.2297, lng: 21.0122 }"
        [zoom]="6"
        [height]="'100%'"
        [width]="'100%'"
        [autoFitBounds]="placesForMap.length > 0"
        [showControls]="true"
        [displayMode]="'full'">
      </app-google-map>
    </div>
  </div>

  <app-add-place-modal
    [isOpen]="showAddPlaceModal"
    (close)="onCloseAddPlaceModal()"
    (placeAdded)="onPlaceAddedFromModal($event)">
  </app-add-place-modal>
</div>
